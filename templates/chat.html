<!-- chat_section.html -->
<div id="chat-section" class="mt-4" style="display:none;">

    <!-- Chat container -->
    <div id="chatContainer" class="p-3 shadow-sm mb-3"
         style="background:white; border-radius:12px; min-height:250px; max-height:500px; overflow-y:auto;">

        {% if initial_bot_msg %}
        <!-- Initial bot message passed from parent template -->
        <div class="botMsg p-2 mb-2" style="background:#f1f0ff; border-radius:8px; max-width:80%;">
            {{ initial_bot_msg|safe }}
        </div>
        {% endif %}

        {% if rag_mode %}
        <!-- if it is rag mode, shift url -->
        <div id="chat_mode" style="display: none;">
            true
            {{ rag_mode|safe }}
        </div>
        {% endif %}

    </div>

    <!-- Chat input -->
    <div class="d-flex gap-2">
        <input type="text" id="chatMessage" class="form-control" placeholder="Send a message">
        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", () => {

    const chatContainer = document.getElementById("chatContainer");
    const chatInput = document.getElementById("chatMessage");
    const sendBtn = document.getElementById("sendBtn");

    let conversationHistory = [];

    // ===============================
    // Helper: CSRF Token
    // ===============================
    function getCSRFToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : '';
    }

    // ===============================
    // Helper: Add User Message
    // ===============================
    function addUserMessage(message) {
        const div = document.createElement("div");
        div.className = "userMsg p-2 mb-2";
        div.style.cssText =
            "background:#e6ffe6; border-radius:8px; max-width:80%; margin-left:auto;";
        div.innerText = message;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ===============================
    // Helper: Add Bot Placeholder
    // ===============================
    function addBotPlaceholder() {
        const div = document.createElement("div");
        div.className = "botMsg p-2 mb-2";
        div.style.cssText =
            "background:#f1f0ff; border-radius:8px; max-width:80%; white-space:pre-wrap;";
        div.innerText = "...";
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return div;
    }

    // ===============================
    // MAIN: Send Message
    // ===============================
    sendBtn.addEventListener("click", async () => {

        // Determine fetch URL dynamically
    const pageTypeEl = document.getElementById("page-type");
    let chatUrl = '/chat_followup/'; // default
if (pageTypeEl) {
    const pageType = pageTypeEl.dataset.page;
    if (pageType === "chat_with_docs") {
        chatUrl = '/chat_with_docs_followup/';
    }
}


        const message = chatInput.value.trim();
        if (!message) return;

        addUserMessage(message);
        chatInput.value = "";
        const botMsg = addBotPlaceholder()
        const originalResponse = document.getElementById("initialResponse")
        if (conversationHistory.length===0){

            conversationHistory.push({ role: "assistant", content: originalResponse.innerText });
        
        }
        console.log(conversationHistory)
        // ===========================
        // SEND TO /chat_followup/
        // ===========================
        const chat_mode = document.getElementById("chat_mode")
        const docId = localStorage.getItem("doc_id");
        console.log(docId)
        console.log(message)
        // console.log(chat_mode.innerText)
        const response = await fetch(chatUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                history: conversationHistory,
                user_message: message,
                doc_id: docId
            }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let fullText = "";

        // STREAM
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            fullText += chunk;

            botMsg.innerHTML = marked.parse(fullText);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        conversationHistory=[]
        // Update conversation
        conversationHistory.push({ role: "assistant", content: fullText });
    });

    // ENTER key support
    chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendBtn.click();
            e.preventDefault();
        }
    });

});
</script>
